<ng-container *ngIf="!floating" [ngTemplateOutlet]="labelTemplate"/>
<div [ngClass]="{ 'ng-invalid': control?.invalid, 'ng-valid': control?.valid }" class="dropdown-container">

  <div class="input-group" [class.form-floating]="floating">
    <button
      #dropdownToggle
      (blur)="onTouched(); ngyBlur.emit($event)"
      (click)="toggleClick($event); ngyClick.emit($event)"
      (contextmenu)="ngyContextMenu.emit($event)"
      [disabled]="disabled"
      [ngClass]="{ 'ng-invalid': control?.invalid, 'ng-valid': control?.valid }"
      class="form-control flex-grow-1 d-flex justify-content-between align-items-center "
      type="button">
      <span class="text-truncate">{{ labels$ | observableString }}</span>
      <div>&nbsp;</div>
      <div>
        <svg [ngStyle]="{rotate: showDropdown ? '180deg': '0deg' }" style="transition: rotate 100ms ease"
             xmlns="http://www.w3.org/2000/svg" width="16"
             height="16" fill="currentColor"
             viewBox="0 0 16 16">
          <path
            d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
        </svg>
      </div>
    </button>
    <ng-container *ngIf="floating" [ngTemplateOutlet]="labelTemplate"/>
    <button *ngIf="showClearButton" type="button"
            class="ngy-combobox-clear-button btn btn-outline-secondary border flex-grow-0 d-flex align-items-center"
            (click)="emptySelection()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path
          d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
      </svg>
    </button>

  </div>

  <div #dropdownMenu [id]="id + '_' + key"
       class="dropdown-menu shadow"
       role="menu">
    <ng-container [ngTemplateOutlet]="inputTemplate"/>
    <div class="ngy-combobox-item-list position-relative d-flex flex-column align-items-stretch" [ngStyle]="{'--ngy-dropdown-max-height': maxHeight}">
      <ng-container *ngIf="multiple">
        <label
          *ngFor="let option of filteredOptions; let i = index"
          class="select-list-item hstack align-items-center gap-2 flex-fill py-2 ps-3 pe-2"
          [class.active]="selectedItemIndex == i">
          <input
            (change)="changeCheckControl($event, option); focusSearch()"
            [checked]="valIncludes($any(val),option.value)"
            [disabled]="disabled"
            [value]="option.value"
            tabindex="-1"
            class="form-check-input m-0"
            type="checkbox"/>
          <span>{{ option.label | observableString }}</span>
        </label>
      </ng-container>

      <ng-container *ngIf="!multiple">
        <button *ngFor="let option of filteredOptions; let i = index"
                (click)="clickedControl($event,option.value, option.label)"
                class="dropdown-item"
                tabindex="-1"
                [class.active]="selectedItemIndex == i"
                type="button">
          {{ option.label | observableString }}
        </button>
      </ng-container>
    </div>
  </div>
</div>

<ng-content select="ngy-helper-text"></ng-content>
<ng-content select="ngy-invalid-message"></ng-content>

<ng-template #inputTemplate>
  <div class="px-2 mb-2">
    <input #searchInputRef
           (keydown.enter)="inputEnter($event)"
           (keydown.arrowDown)="arrowDown($event)"
           (keydown.arrowUp)="arrowUp($event)"
           (keydown.escape)="inputEscape($event)"
           (keydown.tab)="inputTab($event)"
           (input)="searchInput($event)"
           tabindex="-1"
           type="text" class="form-control"
           placeholder="Search here...">
  </div>
</ng-template>

<ng-template #labelTemplate>
  <label (click)="toggleDropdown($event)" class="form-label">{{ label | observableString }}</label>
</ng-template>
